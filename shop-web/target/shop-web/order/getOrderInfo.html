<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>结算页</title>

	<link rel="stylesheet" type="text/css" href="../shop/css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="../shop/css/pages-getOrderInfo.css" />
	<script type="text/javascript" src="../shop/js/plugins/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="../shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
	<script type="text/javascript" src="../shop/js/plugins/sui/sui.min.js"></script>
	<!--<script type="text/javascript" src="shop/components/ui-modules/nav/nav-portal-top.js"></script>-->
	<!--<script type="text/javascript" src="shop/js/pages/getOrderInfo.js"></script>-->
</head>

<body>
<!--head-->
<div class="top">
	<div class="py-container">
		<div class="shortcut">
			<ul class="fl">
				<li class="f-item">品优购欢迎您！</li>
				<li class="f-item">请登录　<span><a href="#">免费注册</a></span></li>
			</ul>
			<ul class="fr">
				<li class="f-item">我的订单</li>
				<li class="f-item space"></li>
				<li class="f-item">我的品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">品优购会员</li>
				<li class="f-item space"></li>
				<li class="f-item">企业采购</li>
				<li class="f-item space"></li>
				<li class="f-item">关注品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">客户服务</li>
				<li class="f-item space"></li>
				<li class="f-item">网站导航</li>
			</ul>
		</div>
	</div>
</div>

<div class="cart py-container">
	<!--logoArea-->
	<div class="logoArea">
		<div class="fl logo"><span class="title">结算页</span></div>
		<div class="fr search">
			<form class="sui-form form-inline">
				<div class="input-append">
					<input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营" />
					<button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
				</div>
			</form>
		</div>
	</div>
	<!--主内容-->
	<div class="checkout py-container">
		<div class="checkout-tit">
			<h4 class="tit-txt">填写并核对订单信息</h4>
		</div>
		<div class="checkout-steps">
			<!--收件人信息-->
			<div class="step-tit">
				<h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false" class="newadd">新增收货地址</a></span></h5>
			</div>
			<div class="step-cont">
				<div class="addressInfo">
					<ul class="addr-detail">
						<li class="addr-item" id="addressShow">
                             <!--拼接收货人地址-->
							<!--<div>
								<div class="con name selected"><a href="javascript:;" >张默<span title="点击取消选择">&nbsp;</a></div>
								<div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span>
									<span class="base">默认地址</span>
									<span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
								</div>
								<div class="clearfix"></div>
							</div>
							<div>
								<div class="con name"><a href="javascript:;">李煜<span title="点击取消选择">&nbsp;</a></div>
								<div class="con address">李煜 北京市海淀区三环内 中关村软件园8号楼 <span>187****4201</span>
									<span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
								</div>
								<div class="clearfix"></div>
							</div>

							<div>
								<div class="con name"><a href="javascript:;">王希<span title="点击取消选择">&nbsp;</a></div>
								<div class="con address">王希 北京市海淀区三环内 中关村软件园6号楼  <span>156****5681</span>
									<span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
								</div>
								<div class="clearfix"></div>
							</div>-->
						</li>
					</ul>
					<!--添加地址-->
					<div  tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
									<h4 id="myModalLabel" class="modal-title" onclick="insertAddress()">添加收货地址</h4>
								</div>
								<div class="modal-body">
									<form action="" class="sui-form form-horizontal" id="addressForm">
										<input type="hidden" name="id" class="input-medium">
										<div class="control-group">
											<label class="control-label">收货人：</label>
											<div class="controls">
												<input type="text" name="cnee" class="input-medium">
											</div>
										</div>

										<div class="control-group">
											<label class="control-label">详细地址：</label>
											<div class="controls">
												<input type="text" name="address" class="input-large">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">联系电话：</label>
											<div class="controls">
												<input type="text" name="telphone" class="input-medium">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">邮箱：</label>
											<div class="controls">
												<input type="text" name="email" class="input-medium">
											</div>
										</div>
									</form>
								</div>
								<div class="modal-footer">
									<button type="button" onclick="commitAddressForm()" data-ok="modal" class="sui-btn btn-primary btn-large">确定</button>
									<button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">取消</button>
								</div>
							</div>
						</div>
					</div>
					<!--确认地址-->
				</div>
				<div class="hr"></div>

			</div>
			<div class="hr"></div>
			<!--支付和送货-->
			<div class="payshipInfo">
				<div class="step-tit">
					<h5>支付方式</h5>
				</div>
				<div class="step-cont">
					<ul class="payType">
						<li class="selected">微信付款<span title="点击取消选择"></span></li>
						<li>货到付款<span title="点击取消选择"></span></li>
					</ul>
				</div>
				<div class="hr"></div>
				<div class="step-tit">
					<h5>送货清单</h5>
				</div>
				<div class="step-cont">
					<ul class="send-detail">
						<li>

							<div class="sendGoods" id="cartShopOrderShow">
                                 <!-- 拼接商品-->
								<!--<ul class="yui3-g">
									<li class="yui3-u-1-6">
										<span><img src="img/goods.png"/></span>
									</li>
									<li class="yui3-u-7-12">
										<div class="desc">Apple iPhone 6s (A1700) 64G 玫瑰金色 移动联通电信4G手机硅胶透明防摔软壳 本色系列</div>
										<div class="seven">7天无理由退货</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="price">￥5399.00</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="num">X1</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="exit">有货</div>
									</li>
								</ul>-->

							</div>
						</li>
						<li></li>
						<li></li>
					</ul>
				</div>
				<div class="hr"></div>
			</div>
			<div class="linkInfo">
				<div class="step-tit">
					<h5>发票信息</h5>
				</div>
				<div class="step-cont">
					<span>普通发票（电子）</span>
					<span>个人</span>
					<span>明细</span>
				</div>
			</div>
			<div class="cardInfo">
				<div class="step-tit">
					<h5>使用优惠/抵用</h5>
				</div>
			</div>
		</div>
	</div>
	<div class="order-summary">
		<div class="static fr">
			<div class="list">
				<span><i class="number">1</i>件商品，总商品金额</span>
				<em class="allprice">¥0.00</em>
			</div>
			<div class="list">
				<span>返现：</span>
				<em class="money">0.00</em>
			</div>
			<div class="list">
				<span>运费：</span>
				<em class="transport">0.00</em>
			</div>
		</div>
	</div>
	<div class="clearfix trade">
		<div class="fc-price">应付金额:<span class="price" id="sumPrice">¥0.00</span></div>
		<div class="fc-receiverInfo"></div>
	</div>
	<div class="submit">
		<a class="sui-btn btn-danger btn-xlarge" href="javascript:void(0)" onclick="createOrder()">提交订单</a>
	</div>
</div>

<script>



</script>

<script>
    $(function () {
        var token="";
        if(sessionStorage.getItem("token")){
            token=sessionStorage.getItem("token");
        }
        $.ajaxSetup({ //发送请求前触发
            contentType:"application/x-www-form-urlencoded;charset=utf-8",
            complete: function (XMLHttpRequest,textStatus) {
                var nologin=XMLHttpRequest.getResponseHeader("NOLOGIN");
                if (nologin=="6001" ) {
                    window.location.href="../login/index.html";
                }
            },
            beforeSend: function (xhr) { //可以设置自定义标头
                // alert("获取的token值:"+token);
                xhr.setRequestHeader('token', token);
            }
        })
        addressShow()
    })

    function createOrder(){
        var  addressId = $(".addr-item .selected").attr("addressId");
        $.ajax({
            url:"http://localhost:8095/order/",
            dataType:"json",
            type:"put",
            data:{"addressId":addressId},
            success:function(result){
                var message = "你购买的商品"
                if(result.code == 200){
                    var understockList = result.data.understockList
                    for(var i=0;i<understockList.length;i++){
                        message+=understockList[i].shopName+" "
                    }
                    message += "库存不足"
                    if(understockList.length>0){
                        alert(message)
                    }
                    sessionStorage.setItem("outTradeNo",result.data.outTradeNo)
                    sessionStorage.setItem("orderId",result.data.orderId)
                    location.href="pay.html"
                }else{
                    alert(result.message)
                }
            },
            error:function(){
                bootbox.alert("生成订单失败")
            }
        });
    }

    var  addressShowHtml = "";
	function addressShow(){
        $.ajax({
            url:"http://localhost:8095/address",
            dataType:"json",
            type:"get",
            success:function (result) {
                if(result.code == 200){
					var  addressList = result.data;
                   for(var i=0;i<addressList.length;i++){
                       addressShowHtml+='<div addressId=' + addressList[i].id + '>';
                       if(i == 0){
                           $(".fc-receiverInfo").html("寄送至: "+addressList[i].address+"  收货人: "+addressList[i].cnee+"  联系电话: "+addressList[i].telphone)

                           addressShowHtml+='<div class="con name selected" addressId=' + addressList[i].id + ' ><a  href="javascript:void(0)" >'+addressList[i].cnee+'<span title="点击取消选择">&nbsp;</a></div>';
					   }else{
                           addressShowHtml+='<div class="con name" addressId=' + addressList[i].id + '><a  href="javascript:void(0)">'+addressList[i].cnee+'<span title="点击取消选择">&nbsp;</a></div>'
                       }
                       addressShowHtml+='<div class="con address">';
                       addressShowHtml+=addressList[i].cnee;
                       addressShowHtml+='<span>&nbsp;&nbsp;&nbsp;</span>'
                       addressShowHtml+=addressList[i].address;
                       addressShowHtml+='<span>&nbsp;&nbsp;&nbsp;</span>'
                       addressShowHtml+='<span>'+addressList[i].telphone+'</span>';
                       if(i==0){
                           addressShowHtml+='<span class="base">默认地址</span>';
					   }
                       addressShowHtml+=' <span class="edittext"><a data-toggle="modal" href="javascript:void(0)" onclick="getAddressById('+addressList[i].id+')" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:void(0)" onclick="deleteAddress('+addressList[i].id+')">删除</a></span>';
                       addressShowHtml+='</div>';
                       addressShowHtml+='<div class="clearfix"></div>';
                       addressShowHtml+='</div>';

                   }
				   $("#addressShow").append(addressShowHtml);
                   hover();
                   click();
                    clearInput();
                }
            }
        })
	}

	function commitAddressForm() {
        $.ajax({
            url:"http://localhost:8095/address",
            dataType:"json",
			type:"put",
            data:$("#addressForm").serialize(),
            success:function(result){
               if(result.code == 200){
                     addressShowHtml = "";
                   $("#addressShow").html(addressShowHtml);
                   addressShow();
			   }
            },
            error:function(){
                bootbox.alert("新增地址失败")
            }
        });
    }


    function  getAddressById(id){
        $.ajax({
            url: "http://localhost:8095/address/"+id,
            dataType: "json",
            type: "get",
            success: function (result) {
               /* $('.edit').modal('show');*/
                $("#myModalLabel").html("修改收获地址")
                $("input[name='cnee']").val(result.data.cnee);
                $("input[name='telphone']").val(result.data.telphone);
                $("input[name='email']").val(result.data.email);
                $("input[name='address']").val(result.data.address);
                $("input[name='id']").val(result.data.id);
            },
            error:function (res) {
            }
        })
	}

	function  deleteAddress(id){
        $.ajax({
            url:"http://localhost:8095/address/"+id,
            dataType:"json",
            type:"delete",
            success:function(result){
                if(result.code == 200){
                    addressShowHtml = "";
                    $("#addressShow").html(addressShowHtml);
                    addressShow();
                }
            },
            error:function(){
                bootbox.alert("删除地址失败")
            }
        });
	}

    function clearInput(){
	    $("input").val("")
	}

    function hover(){
        $(".address").hover(function(){
            $(this).addClass("address-hover");
        },function(){
            $(this).removeClass("address-hover");
        });
    }

    function click(){
        $(".addr-item .name").click(function () {
            $(this).toggleClass("selected").parent(0).siblings().find(".name").removeClass("selected");
            if (!$(this).hasClass('selected')) {
                $(".fc-receiverInfo").html('还没有选择收货地址');
            } else {
                var id = $(this).parent(0).attr("addressId");
                $.ajax({
                    url: "http://localhost:8095/address/" +id,
                    dataType: "json",
                    type: "get",
                    success: function (result) {
                        if (result.code == 200) {
                            var data = result.data;
                            $(".fc-receiverInfo").html('寄送至:' + data.address + ' 收货人：' + data.cnee + ' ' + data.telphone);
                        }
                    }
                })
            }
        });

        $(".payType li").click(function(){
            $(this).toggleClass("selected").siblings().removeClass("selected");
        });
    }

</script>

<script>
   $(function () {
       cartShopOrderShow()
   })
    var cartShopOrderHtml = "";
    var count = 0;
	function cartShopOrderShow() {
        $.ajax({
            url:"http://localhost:8094/cartOrder/",
            dataType:"json",
            type:"get",
            success:function(result){
				var data = result.data.shopList;
                for(var i=0;i<data.length;i++){
                    count++;
                    cartShopOrderHtml+='<ul class="yui3-g">';
                    cartShopOrderHtml+='<li class="yui3-u-1-6">';
                    cartShopOrderHtml+='<span><img src="'+data[i].mainImg+'" width="50px"/></span>';
                    cartShopOrderHtml+='</li>';
                    cartShopOrderHtml+=' <li class="yui3-u-7-12">';
                    cartShopOrderHtml+=' <div class="desc">'+data[i].shopName+'</div>';
                    cartShopOrderHtml+=' <div class="seven">7天无理由退货</div>';
                    cartShopOrderHtml+='</li>';
                    cartShopOrderHtml+='<li class="yui3-u-1-12">';
                    cartShopOrderHtml+=' <div class="price">￥'+data[i].subtotal+'</div>';
                    cartShopOrderHtml+=' </li>';
                    cartShopOrderHtml+='<li class="yui3-u-1-12">';
                    cartShopOrderHtml+='<div class="num">X'+data[i].count+'</div>';
                    cartShopOrderHtml+='</li>';
                    cartShopOrderHtml+='<li class="yui3-u-1-12">';
                    if(data[i].isStock==true){
                        cartShopOrderHtml+='<div class="exit">有货</div>';
					}else{
                        cartShopOrderHtml+='<div class="exit">无货</div>';
					}
                    cartShopOrderHtml+='</li>';
                    cartShopOrderHtml+='</ul>';
				}
				$("#cartShopOrderShow").append(cartShopOrderHtml)
				$(".number").html(count);
				$(".allprice").html(result.data.total);
				$("#sumPrice").html(result.data.total);

            },
            error:function(){
                bootbox.alert("")
            }
        });
    }

</script>



<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
	<div class="py-container">
		<div class="footlink">
			<div class="Mod-service">
				<ul class="Mod-Service-list">
					<li class="grid-service-item intro  intro1">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro2">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro  intro3">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro4">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro intro5">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
				</ul>
			</div>
			<div class="clearfix Mod-list">
				<div class="yui3-g">
					<div class="yui3-u-1-6">
						<h4>购物指南</h4>
						<ul class="unstyled">
							<li>购物流程</li>
							<li>会员介绍</li>
							<li>生活旅行/团购</li>
							<li>常见问题</li>
							<li>购物指南</li>
						</ul>

					</div>
					<div class="yui3-u-1-6">
						<h4>配送方式</h4>
						<ul class="unstyled">
							<li>上门自提</li>
							<li>211限时达</li>
							<li>配送服务查询</li>
							<li>配送费收取标准</li>
							<li>海外配送</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>支付方式</h4>
						<ul class="unstyled">
							<li>货到付款</li>
							<li>在线支付</li>
							<li>分期付款</li>
							<li>邮局汇款</li>
							<li>公司转账</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>售后服务</h4>
						<ul class="unstyled">
							<li>售后政策</li>
							<li>价格保护</li>
							<li>退款说明</li>
							<li>返修/退换货</li>
							<li>取消订单</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>特色服务</h4>
						<ul class="unstyled">
							<li>夺宝岛</li>
							<li>DIY装机</li>
							<li>延保服务</li>
							<li>品优购E卡</li>
							<li>品优购通信</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
					</div>
				</div>
			</div>
			<div class="Mod-copyright">
				<ul class="helpLink">
					<li>关于我们<span class="space"></span></li>
					<li>联系我们<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>商家入驻<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!--页面底部END-->
</body>

</html>